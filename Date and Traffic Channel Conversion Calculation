WITH
  task_1 AS (
  SELECT
    TIMESTAMP_MICROS(event_timestamp) AS event_timestamp,
    user_pseudo_id,
    event_bundle_sequence_id AS session_id,
    event_name,
    geo.country AS country,
    device.category AS device_category,
    traffic_source.source AS SOURCE,
    traffic_source.medium AS medium,
    traffic_source.name AS campaign 
  FROM
    `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE
    _TABLE_SUFFIX BETWEEN '20210101'
    AND '20211231'
    AND event_name IN ( 'session_start',
      'view_item',
      'add_to_cart',
      'begin_checkout',
      'add_shipping_info',
      'add_payment_info',
      'purchase'
      ) ),
  task_2 AS (
  SELECT
    DATE(event_timestamp) AS event_date,
    SOURCE,
    medium,
    campaign,
    user_pseudo_id,
    session_id,
    event_name
  FROM
    task_1
  WHERE
    event_name IN ('session_start',
      'add_to_cart',
      'begin_checkout',
      'purchase')
       ),
  task_3 AS (
  SELECT
    event_date,
    SOURCE,
    medium,
    campaign,
    COUNT(DISTINCT
    IF
      (event_name = 'session_start', CONCAT(user_pseudo_id, session_id), NULL)) AS user_sessions_count,
    COUNT(DISTINCT
    IF
      (event_name = 'add_to_cart', CONCAT(user_pseudo_id, session_id), NULL)) AS add_to_cart_count,
    COUNT(DISTINCT
    IF
      (event_name = 'begin_checkout', CONCAT(user_pseudo_id, session_id), NULL)) AS begin_checkout_count,
    COUNT(DISTINCT
    IF
      (event_name = 'purchase', CONCAT(user_pseudo_id, session_id), NULL)) AS purchase_count
  FROM
    task_2
  GROUP BY
    event_date,
    SOURCE,
    medium,
    campaign )
SELECT
  event_date,
  SOURCE,
  medium,
  campaign,
  user_sessions_count,
  round(SAFE_DIVIDE(add_to_cart_count, user_sessions_count),2) AS visit_to_cart,
  round(SAFE_DIVIDE(begin_checkout_count, user_sessions_count),2) AS visit_to_checkout,
  round(SAFE_DIVIDE(purchase_count, user_sessions_count),2) AS visit_to_purchase
FROM
  task_3
LIMIT
  1000;
